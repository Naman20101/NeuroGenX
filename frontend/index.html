<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroGenX Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #e2e8f0;
            transition: background-color 0.3s ease;
        }
        .container-card {
            background-color: #fff;
            border-radius: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        .submit-button {
            transition: all 0.2s ease;
        }
        .submit-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.5), 0 4px 6px -2px rgba(79, 70, 229, 0.05);
        }
        .message-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .message-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .scrollbar-thin {
            scrollbar-width: thin;
            scrollbar-color: #4f46e5 #e2e8f0;
        }
        .scrollbar-thin::-webkit-scrollbar {
            width: 8px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: #e2e8f0;
            border-radius: 10px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background-color: #4f46e5;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 md:p-8">
    <div class="container-card w-full max-w-4xl p-6 md:p-10">
        <h1 class="text-4xl font-extrabold text-center text-indigo-700 mb-2">NeuroGenX Chat</h1>
        <p class="text-center text-gray-500 mb-8 font-light">A chat application powered by Render & Vercel.</p>

        <!-- Authentication Forms -->
        <div id="authContainer">
            <div id="loginFormContainer" class="mb-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 text-center">Login</h2>
                <form id="loginForm" class="flex flex-col gap-4">
                    <input type="text" id="loginUsername" name="username" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Username" required>
                    <input type="password" id="loginPassword" name="password" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Password" required>
                    <button type="submit" class="submit-button bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-lg">
                        Login
                    </button>
                </form>
                <p class="text-center text-sm text-gray-500 mt-4">
                    Don't have an account? <a href="#" id="showRegister" class="text-indigo-600 hover:text-indigo-800 font-medium">Register here</a>.
                </p>
            </div>

            <div id="registerFormContainer" class="mb-6 hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 text-center">Register</h2>
                <form id="registerForm" class="flex flex-col gap-4">
                    <input type="text" id="registerUsername" name="username" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Username" required>
                    <input type="password" id="registerPassword" name="password" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Password" required>
                    <button type="submit" class="submit-button bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-lg">
                        Register
                    </button>
                </form>
                <p class="text-center text-sm text-gray-500 mt-4">
                    Already have an account? <a href="#" id="showLogin" class="text-indigo-600 hover:text-indigo-800 font-medium">Login here</a>.
                </p>
            </div>
        </div>

        <!-- Chat Container (Hidden until authenticated) -->
        <div id="chatContainer" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <span id="welcomeMessage" class="text-lg font-medium text-gray-700"></span>
                <button id="logoutButton" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium">Logout</button>
            </div>
            
            <form id="messageForm" class="flex flex-col md:flex-row gap-4 mb-8">
                <textarea id="message" name="message" rows="1" class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all resize-none" placeholder="Type your message here..." required></textarea>
                <button type="submit" class="submit-button bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-lg flex-none">
                    Send
                </button>
            </form>

            <div class="h-96 overflow-y-auto scrollbar-thin rounded-lg border border-gray-200 p-4 bg-gray-50">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Messages</h2>
                <div id="messagesList" class="space-y-4">
                    <!-- Messages will be dynamically loaded here -->
                </div>
            </div>
        </div>
        
        <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
        
        <script>
            const BACKEND_URL = "https://neurogenx.onrender.com";

            const authContainer = document.getElementById('authContainer');
            const chatContainer = document.getElementById('chatContainer');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const loginFormContainer = document.getElementById('loginFormContainer');
            const registerFormContainer = document.getElementById('registerFormContainer');
            const showLoginBtn = document.getElementById('showLogin');
            const showRegisterBtn = document.getElementById('showRegister');
            const welcomeMessage = document.getElementById('welcomeMessage');
            const logoutButton = document.getElementById('logoutButton');
            
            const messageForm = document.getElementById('messageForm');
            const messagesList = document.getElementById('messagesList');
            const messageInput = document.getElementById('message');

            let socket = null;

            function formatAndRenderMessage(msg) {
                const messageElement = document.createElement('div');
                messageElement.className = 'message-card bg-white p-4 rounded-xl shadow-sm border border-gray-200 fade-in';
                
                let formattedDate = 'Date Unavailable';
                const date = new Date(msg.timestamp);
                if (!isNaN(date.getTime())) {
                    formattedDate = date.toLocaleString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric',
                        hour: 'numeric',
                        minute: 'numeric',
                        hour12: true
                    });
                }

                messageElement.innerHTML = `
                    <p class="font-semibold text-gray-900">${msg.name}</p>
                    <p class="text-gray-700 mt-2">${msg.message}</p>
                    <p class="text-xs text-gray-400 mt-2">${formattedDate}</p>
                `;
                return messageElement;
            }

            function fetchMessages() {
                fetch(`${BACKEND_URL}/api/messages`)
                    .then(response => response.json())
                    .then(messages => {
                        messagesList.innerHTML = '';
                        if (messages.length === 0) {
                            messagesList.innerHTML = '<p class="text-center text-gray-500 font-medium mt-4">No messages yet. Be the first to post!</p>';
                            return;
                        }
                        messages.forEach(msg => messagesList.appendChild(formatAndRenderMessage(msg)));
                    })
                    .catch(error => {
                        console.error('Error retrieving messages:', error);
                        messagesList.innerHTML = '<p class="text-center text-red-500">Failed to load messages. Please check the console for details.</p>';
                    });
            }

            function showChatUI(username) {
                authContainer.classList.add('hidden');
                chatContainer.classList.remove('hidden');
                welcomeMessage.textContent = `Welcome, ${username}!`;
                fetchMessages();
                
                socket = io(BACKEND_URL);
                socket.on('new_message', (msg) => {
                    messagesList.prepend(formatAndRenderMessage(msg));
                });
            }

            function showAuthUI() {
                authContainer.classList.remove('hidden');
                chatContainer.classList.add('hidden');
                if (socket) {
                    socket.disconnect();
                }
            }

            const token = localStorage.getItem('token');
            const username = localStorage.getItem('username');
            if (token && username) {
                showChatUI(username);
            } else {
                showAuthUI();
            }

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = loginUsername.value;
                const password = loginPassword.value;

                try {
                    const response = await fetch(`${BACKEND_URL}/api/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        localStorage.setItem('token', data.token);
                        localStorage.setItem('username', data.username);
                        showChatUI(data.username);
                        loginForm.reset();
                    } else {
                        alert(data.error || 'Login failed.');
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    alert('An error occurred during login. Please try again.');
                }
            });

            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = registerUsername.value;
                const password = registerPassword.value;

                try {
                    const response = await fetch(`${BACKEND_URL}/api/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        alert('Registration successful! You can now log in.');
                        showLoginBtn.click();
                        registerForm.reset();
                    } else {
                        alert(data.error || 'Registration failed.');
                    }
                } catch (error) {
                    console.error('Registration error:', error);
                    alert('An error occurred during registration. Please try again.');
                }
            });

            messageForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const message = messageInput.value;
                const token = localStorage.getItem('token');

                if (!token) {
                    alert('You must be logged in to send a message.');
                    return;
                }

                try {
                    const response = await fetch(`${BACKEND_URL}/api/submit`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ message })
                    });
                    
                    if (response.ok) {
                        messageInput.value = '';
                    } else {
                        const data = await response.json();
                        alert(data.error || 'Failed to send message.');
                    }
                } catch (error) {
                    console.error('Message submission error:', error);
                    alert('An error occurred while sending the message.');
                }
            });

            logoutButton.addEventListener('click', () => {
                localStorage.removeItem('token');
                localStorage.removeItem('username');
                showAuthUI();
            });

            showRegisterBtn.addEventListener('click', (e) => {
                e.preventDefault();
                loginFormContainer.classList.add('hidden');
                registerFormContainer.classList.remove('hidden');
            });

            showLoginBtn.addEventListener('click', (e) => {
                e.preventDefault();
                registerFormContainer.classList.add('hidden');
                loginFormContainer.classList.remove('hidden');
            });
        </script>
    </div>
</body>
</html>

